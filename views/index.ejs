<%- include('layout/header') %>
<% if (message) { %>
    <div class="alert alert-dismissible fade show alert-<%= message.type %>" role="alert">
        <button class="btn-close" type="button" data-bs-dismiss="alert" aria-label="Close"></button>
        <strong><%= message.message %></strong>
    </div>
<% } %>
    
<div class="container">
    <div id="calendar"></div>
</div>
<!-- Start popup dialog box -->
<div class="modal fade" id="event_entry_modal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabel">Add New Event</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="img-container">
                    <div class="row">
                        <div class="col-sm-12">  
                            <div class="form-group">
                                <label for="event_name">Event name</label>
                                <input type="text" name="event_name" id="event_name" class="form-control" placeholder="Enter your event name">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6">  
                            <div class="form-group">
                                <label for="event_start_date">Event start</label>
                                <input type="datetime-local" name="event_start_date" id="event_start_date" class="form-control onlydatepicker" placeholder="Event start date">
                            </div>
                        </div>
                        <div class="col-sm-6">  
                            <div class="form-group">
                                <label for="event_end_date">Event end</label>
                                <input type="datetime-local" name="event_end_date" id="event_end_date" class="form-control" placeholder="Event end date">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">  
                            <div class="form-group">
                                <label for="event_details">Event details</label>
                                <textarea name="event_details" id="event_details" class="form-control" placeholder="Enter event details"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">  
                            <div class="form-group">
                                <label for="all_day_event">All Day Event</label>
                                <input type="checkbox" id="all_day_event">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="save_event()">Save Event</button>
                <button type="button" class="btn btn-primary" onclick="edit_event()">Edit</button>
            </div>
        </div>
    </div>
</div>
<!-- End popup dialog box -->


<!-- Task Table -->
<div class="modal fade" id="task_table_modal" tabindex="-1" role="dialog" aria-labelledby="taskTableLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskTableLabel">Task Table</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col">Task Name</th>
                            <th scope="col">Start Date</th>
                            <th scope="col">End Date</th>
                            <th scope="col">Time</th>
                            <th scope="col">Details</th>
                            <th scope="col">Config</th>
                            <th scope="col"><a href="#" class="text-primary"><i class="fas fa-plus fa-lg mx-1"></i></a></th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Add more rows for other tasks -->
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Start Update Event Modal -->
<div class="modal fade" id="update_event_modal" tabindex="-1" role="dialog" aria-labelledby="updateEventLabel" aria-hidden="true" >
    <div class="modal-dialog modal-md" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateEventLabel">Update Event</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="img-container">
                    <div class="row">
                        <div class="col-sm-12">  
                            <div class="form-group">
                                <label for="update_event_name">Event name</label>
                                <input type="text" name="update_event_name" id="update_event_name" class="form-control" placeholder="Enter updated event name">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6">  
                            <div class="form-group">
                                <label for="update_event_start_date">Event start</label>
                                <input type="datetime-local" name="update_event_start_date" id="update_event_start_date" class="form-control onlydatepicker" placeholder="Event start date">
                            </div>
                        </div>
                        <div class="col-sm-6">  
                            <div class="form-group">
                                <label for="update_event_end_date">Event end</label>
                                <input type="datetime-local" name="update_event_end_date" id="update_event_end_date" class="form-control" placeholder="Event end date">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">  
                            <div class="form-group">
                                <label for="update_event_details">Event details</label>
                                <textarea name="update_event_details" id="update_event_details" class="form-control" placeholder="Enter updated event details"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="update_event()">Update Event</button>
                <button type="button" class="btn btn-primary" onclick="delete_event()">Delete Event</button>
            </div>
        </div>
    </div>
</div>

<!-- End Update Event Modal -->


<script>

    let calendar;
    var updatedEventId;

    document.addEventListener('DOMContentLoaded', function() {

        var calendarEl = document.getElementById('calendar');

        calendar = new FullCalendar.Calendar(calendarEl, {
            selectable: true,
            selectHelper: true,
            select: function(start, end) {
				$('#event_start_date').val(moment(start).format('YYYY-MM-DD'));
				$('#event_end_date').val(moment(end).format('YYYY-MM-DD'));
				$('#event_entry_modal').modal('show');
			},
            initialView: 'dayGridMonth',
            height: 650,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,listWeek'
            },
            eventColor: 'purple',
            events: '/events', 
            eventClick: function(info) {
                // Lấy thông tin về sự kiện
                var eventId = info.event.extendedProps._id;
                updatedEventId = eventId;
                var eventName = info.event.title;
                var eventStart = info.event.start;
                var eventEnd = info.event.end;
                var eventDetails = info.event.extendedProps.details;

                // Cập nhật nội dung của modal với dữ liệu từ sự kiện
                $('#update_event_name').val(eventName);
                $('#update_event_start_date').val(moment(eventStart).format('YYYY-MM-DDTHH:mm'));
                $('#update_event_end_date').val(moment(eventEnd).format('YYYY-MM-DDTHH:mm'));
                $('#update_event_details').val(info.event.extendedProps.details).data('event-id', eventId);
                $('#update_event_details').val(eventDetails);

                // Tạo URL mới với eventId
                var editEventURL = '/edit/' + eventId;
                // Thay đổi URL trên thanh địa chỉ của trình duyệt
                history.pushState({}, '', editEventURL);
                $('#update_event_modal').on('hidden.bs.modal', function (e) {
                    // Khôi phục URL về trạng thái ban đầu
                    var defaultURL = '/'; // URL mặc định của trang
                    history.pushState({}, '', defaultURL);
                });
                // Hiển thị modal khi một sự kiện được click
                $('#update_event_modal').modal('show');
            },
            tasks: []
        });
        calendar.render();
    });

    // Xử lý sự kiện khi người dùng thay đổi trạng thái của ô kiểm tra "Cả ngày"
    $('#all_day_event').change(function() {
        if ($(this).is(":checked")) {
            // Nếu được chọn, ẩn ô nhập liệu thời gian
            $('#event_start_date, #event_end_date').prop('type', 'date');
        } else {
            // Nếu không được chọn, hiển thị lại ô nhập liệu thời gian
            $('#event_start_date, #event_end_date').prop('type', 'datetime-local');
        }
    });


    function save_event() {
        var eventName = $('#event_name').val();
        var eventStart = $('#event_start_date').val();
        var eventEnd = $('#event_end_date').val();
        var eventDetails = $('#event_details').val();

        if (!eventName || !eventStart || !eventEnd) {
            alert("Vui lòng điền đầy đủ thông tin sự kiện!");
            return;
        }

        var eventData = {
            title: eventName,
            start: eventStart,
            end: eventEnd,
            details: eventDetails
        };

        $.ajax({
            type: 'POST',
            url: '/addEvent', // Thay đổi đường dẫn này nếu cần
            data: eventData,
            success: function(response) {
                alert(response); // Hiển thị thông báo thành công từ máy chủ
                calendar.refetchEvents();
                // Xóa dữ liệu từ form
                $('#event_name').val('');
                $('#event_start_date').val('');
                $('#event_end_date').val('');
                $('#event_details').val('');
                // Đóng modal
                $('#event_entry_modal').modal('hide');
            },
            error: function(xhr, status, error) {
                console.error("Lỗi khi tạo sự kiện:", error);
                alert("Đã xảy ra lỗi khi tạo sự kiện!");
            }
        });
    }

    function update_event() {
        var updatedEventName = $('#update_event_name').val();
        var updatedEventStart = $('#update_event_start_date').val();
        var updatedEventEnd = $('#update_event_end_date').val();
        var updatedEventDetails = $('#update_event_details').val();

        // Kiểm tra xem tất cả các trường đã được điền đầy đủ không
        if (!updatedEventName || !updatedEventStart || !updatedEventEnd) {
            alert("Please fill in all fields for the updated event!");
            return;
        }

        // Tạo đối tượng dữ liệu sự kiện cập nhật
        var updatedEventData = {
            title: updatedEventName,
            start: updatedEventStart,
            end: updatedEventEnd,
            details: updatedEventDetails
        };
        // Gửi yêu cầu cập nhật sự kiện đến máy chủ
        $.ajax({
            type: 'POST',
            url: '/update/' + updatedEventId, // Thay đổi đường dẫn này nếu cần
            data: updatedEventData,
            success: function(response) {
                // alert(response); // Hiển thị thông báo thành công từ máy chủ
                calendar.refetchEvents();
                $('#update_event_modal').modal('hide');
            },
            error: function(xhr, status, error) {
                console.error("Error updating event:", error);
                alert("An error occurred while updating the event!");
            }
        });
    }
    function delete_event() {
        if (confirm("Are you sure you want to delete this event?")) {
            $.ajax({
                type: 'POST',
                url: '/delete/' + updatedEventId, // Đường dẫn để xóa sự kiện, hãy đảm bảo nó phù hợp với route của bạn
                success: function(response) {
                    // alert(response); // Hiển thị thông báo thành công từ máy chủ
                    calendar.refetchEvents(); // Làm mới lịch để cập nhật sự kiện bị xóa
                    $('#update_event_modal').modal('hide'); // Đóng modal sau khi xóa
                },
                error: function(xhr, status, error) {
                    console.error("Error deleting event:", error);
                    alert("An error occurred while deleting the event!");
                }
            });
        }
    }
</script>

<%- include('layout/footer') %>
